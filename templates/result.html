<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <title>Hasil Prediksi & Evaluasi Model</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
    />
    <style>
      body {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        min-height: 100vh;
      }
      .container {
        margin-top: 32px;
      }
      .judul {
        color: #fff;
        text-align: center;
        margin-bottom: 16px;
        text-shadow: 1px 2px 4px #0005;
      }
      .card-custom {
        background: linear-gradient(120deg, #f5fafd 60%, #e6f0fa 100%);
        border: none;
        border-radius: 1rem;
        box-shadow: 0 6px 40px 0 #0001;
        margin-bottom: 20px;
      }
      .kembali-btn {
        background: linear-gradient(90deg, #1976d2 0%, #64b5f6 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        padding: 8px 24px;
        transition: background 0.2s;
      }
      .kembali-btn:hover {
        background: linear-gradient(90deg, #1565c0 0%, #42a5f5 100%);
      }
      pre {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="judul">Hasil Prediksi & Evaluasi Model Random Forest</h1>

      {% if results %}
      <div class="card card-custom">
        <div class="card-body">
          <h3>Laporan Evaluasi Model</h3>

          {% if results.report_text %}
          <h6>Classification Report:</h6>
          <pre>{{ results.report_text }}</pre>
          {% endif %}

          <div class="row">
            <div class="col-md-6">
              <h6>Confusion Matrix</h6>
              {% if results.cm_div %}
              <div>{{ results.cm_div | safe }}</div>
              {% elif results.cm_html_path %}
              <iframe
                src="{{ url_for('static', filename='plots/cm_plot.html') }}"
                style="width: 100%; height: 350px; border: none"
              ></iframe>
              {% endif %}
            </div>

            <div class="col-md-6">
              <h6>
                ROC Curve
                <small class="text-muted"
                  >AUC = {{ results.roc_auc|default('N/A') }}</small
                >
              </h6>
              {% if results.roc_div %}
              <div>{{ results.roc_div | safe }}</div>
              {% elif results.roc_html_path %}
              <iframe
                src="{{ url_for('static', filename='plots/roc_plot.html') }}"
                style="width: 100%; height: 350px; border: none"
              ></iframe>
              {% endif %}
            </div>
          </div>

          <div class="mt-3">
            <h6>Feature Importances</h6>
            {% if results.feat_div %}
            <div>{{ results.feat_div | safe }}</div>
            {% elif results.feat_html_path %}
            <iframe
              src="{{ url_for('static', filename='plots/feat_plot.html') }}"
              style="width: 100%; height: 400px; border: none"
            ></iframe>
            {% endif %}
          </div>

          {% if results.tree_path %}
          <div class="mt-3">
            <h6>Decision Tree Overview</h6>
            <img src="{{ results.tree_path }}" class="img-fluid" />
          </div>
          {% endif %}

          <ul class="mt-3">
            <li>
              Out-of-Bag Score:
              <b>
                {% if results.oob_score is defined and results.oob_score is not none %}
                  {{ results.oob_score|round(4) }}
                {% else %}
                  N/A
                {% endif %}
              </b>
            </li>
            <li>
              Waktu Training (total):
              <b>
                {% if results.train_time is defined and results.train_time is not none %}
                  {{ results.train_time|round(2) }}
                {% else %}
                  N/A
                {% endif %}
              </b>
              detik
            </li>
            {% if results.train_fit_time is defined and results.train_fit_time is not none %}
            <li>
              Waktu Fit Final Model: <b>{{ results.train_fit_time|round(2) }}</b> detik
            </li>
            {% endif %}
            {% if results.tuning_time is defined and results.tuning_time %}
            <li>
              Waktu Tuning (GridSearch): <b>{{ results.tuning_time|round(2) }}</b> detik
            </li>
            {% endif %}
          </ul>

          {% if results.tuning_table %}
          <hr />
          <h4 class="mt-4">Hasil GridSearchCV (Tuning)</h4>
          <div class="table-responsive">
            <table id="tuningTable" class="table table-striped">
              <thead class="table-dark">
                <tr>
                  <th>n_estimators</th>
                  <th>max_depth</th>
                  <th>min_samples_split</th>
                  <th>mean_test_score</th>
                  <th>rank_test_score</th>
                </tr>
              </thead>
              <tbody>
                {% for row in results.tuning_table %}
                <tr>
                  <td>{{ row.param_n_estimators }}</td>
                  <td>{{ row.param_max_depth }}</td>
                  <td>{{ row.param_min_samples_split }}</td>
                  <td>
                    {% if row.mean_test_score is defined and row.mean_test_score is not none %}
                      {{ ('{:.4f}'.format(row.mean_test_score)) }}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td>{{ row.rank_test_score }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if results.tuning_csv %}
          <a
            href="{{ url_for('static', filename='tuning_results.csv') }}"
            class="btn btn-sm btn-outline-secondary mt-2"
            >Download CSV hasil tuning</a
          >
          {% endif %} {% endif %}
        </div>
      </div>
      {% endif %} {% if pred_result %}
      <div class="card card-custom">
        <div class="card-body">
          <h3>Hasil Prediksi Customer</h3>
          {% if pred_result.error %}
          <div class="alert alert-danger">{{ pred_result.error }}</div>
          {% else %}
          {% if pred_result.churn_pred == 1 %}
          <div class="alert alert-danger text-center fs-5">ðŸ˜¢ Pelanggan ini berpotensi <b>BERHENTI BERLANGGANAN!</b></div>
          {% else %}
          <div class="alert alert-success text-center fs-5"> Pelanggan ini kemungkinan <b>TETAP BERLANGGANAN</b>.</div>
          {% endif %}

          <p>
            Probabilitas Churn:
            <strong>{{ (((pred_result.prob_churn|default(0)) * 100)|round(2)) }}%</strong>
          </p>

          <h6>Decision Path (visual)</h6>
          {% if pred_result.decision_path %}
          <img
            src="/{{ pred_result.decision_path }}"
            class="img-fluid"
            style="max-width: 100%; border-radius: 8px"
          />
          <div class="small text-secondary mt-2">
            <em
              >Garis bawah menunjukkan node yang dilalui pada salah satu pohon
              estimator (overview).</em
            >
          </div>
          {% endif %} {% endif %}
        </div>
      </div>
      {% endif %}

      <div class="text-center mb-5">
        <a href="/" class="kembali-btn">Kembali ke Beranda</a>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script>
      $(document).ready(function () {
        if ($("#tuningTable").length) {
          $("#tuningTable").DataTable();
        }
      });
    </script>
  </body>
</html>
